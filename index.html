<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LES AFFAIRES NON RESOLUES — Jeu d'Enquête</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400&family=IBM+Plex+Mono:wght@400&family=Inter:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    /* ─────────────────────────────────────────────
       DESIGN TOKENS
    ───────────────────────────────────────────── */
    :root {
      --bg:             #0a0a0a;
      --bg-raised:      #111111;
      --bg-card:        #141414;
      --text-primary:   #e8e8e8;
      --text-secondary: #a0a0a0;
      --text-muted:     #686868;
      --border:         #2a2a2a;
      --border-active:  #555555;
      --accent:         #c8b896;
      --accent-dim:     #6b5e3f;
      --danger:         #8b3a3a;
      --danger-dim:     #5a2525;
    }

    /* ─────────────────────────────────────────────
       RESET & BASE
    ───────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    html { height: 100%; }
    body {
      min-height: 100%;
      background: var(--bg);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      line-height: 1.8;
      overflow-x: hidden;
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #222222; }

    /* ─────────────────────────────────────────────
       TYPOGRAPHY UTILITIES
    ───────────────────────────────────────────── */
    .t-title {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 300;
      letter-spacing: 0.08em;
    }
    .t-heading {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 400;
      letter-spacing: 0.04em;
    }
    .t-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      font-weight: 400;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .t-mono {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.72rem;
      letter-spacing: 0.15em;
    }

    /* ─────────────────────────────────────────────
       LAYOUT
    ───────────────────────────────────────────── */
    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 24px 80px;
    }

    .screen {
      width: 100%;
      max-width: 540px;
      display: none;
      flex-direction: column;
      gap: 0;
      animation: screenIn 400ms ease forwards;
    }
    .screen.active {
      display: flex;
    }

    @keyframes screenIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    /* ─────────────────────────────────────────────
       CARD
    ───────────────────────────────────────────── */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 32px;
      animation: cardIn 350ms cubic-bezier(0.22, 1, 0.36, 1) backwards;
    }
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .card + .card { margin-top: 12px; }
    .card.delay-1 { animation-delay: 80ms; }
    .card.delay-2 { animation-delay: 160ms; }
    .card.delay-3 { animation-delay: 240ms; }
    .card.delay-4 { animation-delay: 320ms; }

    /* ─────────────────────────────────────────────
       BUTTONS
    ───────────────────────────────────────────── */
    button {
      display: block;
      width: 100%;
      max-width: 340px;
      margin: 0 auto;
      padding: 14px 24px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.72rem;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      transition: border-color 200ms ease, color 200ms ease, background 200ms ease;
      text-align: center;
    }
    /* Primary */
    .btn-primary {
      border: 1px solid var(--border-active);
      color: var(--text-secondary);
    }
    .btn-primary:hover {
      border-color: var(--accent-dim);
      color: var(--accent);
    }
    /* Secondary */
    .btn-secondary {
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.68rem;
    }
    .btn-secondary:hover {
      border-color: var(--accent-dim);
      color: var(--accent);
    }
    /* Tertiary */
    .btn-tertiary {
      border: 1px solid transparent;
      color: var(--text-muted);
      font-size: 0.65rem;
    }
    .btn-tertiary:hover {
      border-color: var(--border);
      color: var(--text-secondary);
    }
    /* Danger */
    .btn-danger {
      border: 1px solid var(--danger-dim);
      color: var(--text-muted);
    }
    .btn-danger:hover {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(139, 58, 58, 0.06);
    }

    /* ─────────────────────────────────────────────
       DIVIDER
    ───────────────────────────────────────────── */
    .divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 24px 0;
    }
    .divider-tight {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    /* ─────────────────────────────────────────────
       SCREEN: ACCUEIL
    ───────────────────────────────────────────── */
    .home-header {
      text-align: center;
      padding: 48px 0 40px;
    }
    .home-title {
      font-size: clamp(2.8rem, 15vw, 5rem);
      line-height: 1;
      margin-bottom: 8px;
    }
    .home-sub {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }
    .home-desc {
      color: var(--text-secondary);
      font-size: 0.925rem;
      line-height: 1.85;
      max-width: 400px;
      margin: 0 auto;
    }
    .home-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 32px;
    }

    /* ─────────────────────────────────────────────
       SCREEN: SÉLECTION DIFFICULTÉ
    ───────────────────────────────────────────── */
    .difficulty-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 20px;
    }
    .difficulty-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 20px 24px;
      cursor: pointer;
      transition: border-color 200ms ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .difficulty-card:hover {
      border-color: var(--border-active);
    }
    .difficulty-card.selected {
      border-color: var(--accent-dim);
    }

    /* Exceptional / locked card */
    .difficulty-card.exceptional {
      border-color: var(--accent-dim);
      position: relative;
    }
    .difficulty-card.exceptional .diff-title {
      color: var(--accent);
    }
    .difficulty-card.locked {
      opacity: 0.4;
      cursor: not-allowed;
      border-color: var(--border);
    }
    .difficulty-card.locked .diff-title {
      color: var(--text-muted);
    }
    .exceptional-badge {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.55rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent-dim);
      margin-bottom: 2px;
    }
    .exceptional-status {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.62rem;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      text-align: right;
    }
    .diff-title { font-size: 1.1rem; color: var(--text-primary); }
    .diff-info { font-size: 0.7rem; color: var(--text-muted); text-align: right; }

    /* ─────────────────────────────────────────────
       SCREEN: INTRO ENQUÊTE
    ───────────────────────────────────────────── */
    .case-title {
      font-size: clamp(1.6rem, 7vw, 2.4rem);
      line-height: 1.2;
      margin-bottom: 8px;
    }
    .case-body {
      color: var(--text-secondary);
      font-size: 0.925rem;
      line-height: 1.85;
    }
    .suspects-list {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .suspect-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .suspect-name { color: var(--text-primary); font-size: 0.9rem; }
    .suspect-meta { font-size: 0.68rem; color: var(--text-secondary); font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.12em; text-transform: uppercase; }

    /* ─────────────────────────────────────────────
       SCREEN: JEU PRINCIPAL
    ───────────────────────────────────────────── */
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 20px;
    }
    .game-title { font-size: clamp(1.1rem, 5vw, 1.6rem); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      padding: 10px 20px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color 200ms ease, border-color 200ms ease;
      background: transparent;
      border-top: none;
      border-left: none;
      border-right: none;
      max-width: none;
      width: auto;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .tab:hover { color: var(--text-secondary); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent-dim); }

    /* Tab panels */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ─────────────────────────────────────────────
       GRILLE DE DÉDUCTION
    ───────────────────────────────────────────── */
    .grid-section-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
      margin-top: 20px;
    }
    .grid-section-label:first-child { margin-top: 0; }

    .deduction-grid {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 4px;
    }
    .deduction-grid th,
    .deduction-grid td {
      border: 1px solid var(--border);
      text-align: center;
      vertical-align: middle;
    }
    .deduction-grid th {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-secondary);
      padding: 8px 4px;
      background: var(--bg-raised);
    }
    .deduction-grid td {
      padding: 0;
      width: 52px;
      height: 44px;
    }
    .deduction-grid td:first-child {
      text-align: left;
      padding: 8px 12px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      color: var(--text-primary);
      background: var(--bg-raised);
      width: auto;
      white-space: nowrap;
    }
    .cell-btn {
      width: 100%;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      background: transparent;
      transition: background 200ms ease;
      font-size: 0.9rem;
      max-width: none;
      padding: 0;
      margin: 0;
      letter-spacing: 0;
      text-transform: none;
      font-family: 'Inter', sans-serif;
    }
    .cell-btn:hover { background: rgba(200,184,150,0.04); }
    .cell-btn[data-state="yes"] {
      color: var(--accent);
      background: rgba(200,184,150,0.06);
    }
    .cell-btn[data-state="no"] {
      color: var(--danger);
      background: rgba(139,58,58,0.05);
    }
    .cell-btn[data-state="empty"] { color: var(--text-muted); }

    /* Legend */
    .grid-legend {
      display: flex;
      gap: 20px;
      margin-top: 12px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.58rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .legend-sym { font-size: 0.85rem; }

    /* ─────────────────────────────────────────────
       INDICES
    ───────────────────────────────────────────── */
    .clues-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .clue-item {
      border: 1px solid var(--border);
      padding: 16px 20px;
      background: var(--bg-card);
      cursor: pointer;
      transition: border-color 200ms ease;
      animation: cardIn 350ms cubic-bezier(0.22, 1, 0.36, 1) backwards;
    }
    .clue-item:hover { border-color: var(--border-active); }
    .clue-item.used { border-color: var(--border); opacity: 0.45; }
    .clue-number {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .clue-text {
      font-size: 0.925rem;
      color: var(--text-primary);
      line-height: 1.75;
    }
    .clue-item.revealed .clue-text { color: var(--accent); }

    /* ─────────────────────────────────────────────
       NOTES LIBRES
    ───────────────────────────────────────────── */
    .notes-area {
      width: 100%;
      background: var(--bg-raised);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      line-height: 1.75;
      padding: 20px;
      resize: vertical;
      min-height: 200px;
      transition: border-color 200ms ease;
      outline: none;
    }
    .notes-area:focus { border-color: var(--border-active); }
    .notes-area::placeholder { color: var(--text-muted); }

    /* ─────────────────────────────────────────────
       ACCUSATION
    ───────────────────────────────────────────── */
    .accusation-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .accusation-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.62rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .accusation-select {
      width: 100%;
      background: var(--bg-raised);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      padding: 12px 16px;
      outline: none;
      transition: border-color 200ms ease;
      cursor: pointer;
    }
    .accusation-select:focus { border-color: var(--border-active); }
    .accusation-select option {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    /* ─────────────────────────────────────────────
       TIMER
    ───────────────────────────────────────────── */
    .timer {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 1rem;
      color: var(--text-muted);
      letter-spacing: 0.1em;
    }
    .timer.warning { color: var(--danger); }
    @keyframes pulse-timer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .timer.pulsing { animation: pulse-timer 1s ease-in-out infinite; }

    /* ─────────────────────────────────────────────
       AMBIENT PULSE (loading / waiting)
    ───────────────────────────────────────────── */
    @keyframes ambientPulse {
      0%, 100% { opacity: 0.3; }
      50%       { opacity: 0.7; }
    }
    .ambient { animation: ambientPulse 4s ease-in-out infinite; }

    /* ─────────────────────────────────────────────
       RÉSULTAT (VICTOIRE / DÉFAITE)
    ───────────────────────────────────────────── */
    .result-icon {
      font-size: 3.5rem;
      font-family: 'Cormorant Garamond', serif;
      font-weight: 300;
      text-align: center;
      margin-bottom: 16px;
      letter-spacing: 0.1em;
    }
    .result-icon.victory { color: var(--accent); }
    .result-icon.defeat  { color: var(--danger); }
    .result-title {
      font-size: clamp(2rem, 9vw, 2.8rem);
      text-align: center;
      margin-bottom: 8px;
    }
    .result-sub {
      color: var(--text-secondary);
      text-align: center;
      font-size: 0.925rem;
      line-height: 1.85;
    }
    .verdict-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .verdict-key { color: var(--text-secondary); font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; }
    .verdict-val { color: var(--text-primary); font-size: 0.875rem; }
    .verdict-val.correct { color: var(--accent); }
    .verdict-val.wrong   { color: var(--danger); }

    /* ─────────────────────────────────────────────
       RÈGLES
    ───────────────────────────────────────────── */
    .rules-section h3 {
      font-size: 1rem;
      margin: 20px 0 8px;
      color: var(--text-secondary);
    }
    .rules-section p {
      font-size: 0.925rem;
      color: var(--text-secondary);
      line-height: 1.85;
      margin-bottom: 8px;
    }

    /* ─────────────────────────────────────────────
       MISC
    ───────────────────────────────────────────── */
    .spacer { height: 20px; }
    .spacer-lg { height: 32px; }
    .text-center { text-align: center; }
    .mt-8  { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .mt-20 { margin-top: 20px; }
    .mt-24 { margin-top: 24px; }
    .mt-32 { margin-top: 32px; }

    .badge {
      display: inline-block;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.58rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 3px 8px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }
    .badge.accent { border-color: var(--accent-dim); color: var(--accent); }

    .progress-bar {
      height: 2px;
      background: var(--border);
      margin: 16px 0;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent-dim);
      transition: width 400ms ease;
    }

    /* ─────────────────────────────────────────────
       RESPONSIVE
    ───────────────────────────────────────────── */

    /* Grid: make it scrollable horizontally on small screens */
    .grid-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .grid-wrapper::-webkit-scrollbar { height: 4px; }
    .grid-wrapper::-webkit-scrollbar-thumb { background: #222; }

    /* Larger touch targets for cell buttons on mobile */
    @media (hover: none) and (pointer: coarse) {
      .cell-btn {
        height: 48px;
        font-size: 1rem;
      }
      .deduction-grid td {
        height: 48px;
        min-width: 48px;
      }
      .tab {
        padding: 12px 14px;
        font-size: 0.62rem;
        letter-spacing: 0.12em;
      }
      .clue-item {
        padding: 20px;
      }
      button {
        padding: 16px 24px;
      }
    }

    /* Small phones (< 400px) */
    @media (max-width: 400px) {
      #app {
        padding: 24px 16px 60px;
      }
      .card {
        padding: 20px;
      }
      /* home-title handled by clamp() */
      .home-header {
        padding: 32px 0 28px;
      }
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .tabs::-webkit-scrollbar { display: none; }
      .tab {
        padding: 10px 12px;
        font-size: 0.6rem;
        letter-spacing: 0.1em;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .game-title { }
      .timer { font-size: 0.85rem; }
      .case-title { }
      .result-title { }
      .deduction-grid th {
        font-size: 0.55rem;
        padding: 6px 3px;
        letter-spacing: 0.06em;
      }
      .deduction-grid td:first-child {
        font-size: 0.58rem;
        padding: 6px 8px;
        letter-spacing: 0.04em;
      }
    }

    /* Medium screens (400–600px) */
    @media (max-width: 600px) {
      #app {
        padding: 28px 20px 60px;
      }
      .card {
        padding: 24px;
      }
      .home-title {
        /* handled by clamp() */
      }
      .difficulty-card {
        padding: 16px 20px;
      }
      .suspect-item {
        flex-direction: column;
        gap: 2px;
        align-items: flex-start;
      }
      .accusation-label {
        font-size: 0.6rem;
      }
      .accusation-select {
        font-size: 0.7rem;
        padding: 12px 14px;
      }
    }

    /* Ensure grid never breaks layout */
    @media (max-width: 540px) {
      .deduction-grid {
        font-size: 0.8rem;
      }
      .deduction-grid td {
        width: 44px;
        height: 44px;
        min-width: 40px;
      }
      .deduction-grid td:first-child {
        white-space: normal;
        word-break: break-word;
        max-width: 90px;
        min-width: 70px;
      }
    }
  </style>
</head>
<body>
<div id="app">

  <!-- ══════════════════════════════════════════
       ÉCRAN 0 — ACCUEIL
  ══════════════════════════════════════════ -->
  <section class="screen active" id="screen-home">
    <div class="home-header">
      <div class="t-label ambient" style="margin-bottom:20px;">Jeu d'enquête et de déduction</div>
      <h1 class="t-title home-title">LES AFFAIRES NON RESOLUES</h1>
      <p class="t-heading home-sub">— Qui a commis le crime ? —</p>
      <p class="home-desc">
        Un meurtre a été commis. Des suspects, des lieux, des armes. 
        À partir des indices, remplissez la grille de déduction et désignez le coupable avant le temps imparti.
      </p>
    </div>

    <div class="card">
      <div class="t-label" style="margin-bottom:16px;">Commencer une partie</div>
      <div class="home-actions">
        <button class="btn-primary" onclick="showScreen('screen-difficulty')">Nouvelle Enquête</button>
        <button class="btn-secondary" onclick="showScreen('screen-rules')">Règles du jeu</button>
      </div>
    </div>

    <div class="card delay-1 mt-12" style="padding:20px 32px;">
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <span class="t-label">Meilleure partie</span>
        <span id="best-time" class="t-mono" style="color:var(--text-muted)">—</span>
      </div>
    </div>
  </section>

  <!-- ══════════════════════════════════════════
       ÉCRAN 1 — RÈGLES
  ══════════════════════════════════════════ -->
  <section class="screen" id="screen-rules">
    <div class="mt-32">
      <div class="t-label mb" style="margin-bottom:8px;">Retour</div>
      <button class="btn-tertiary" style="margin:0;text-align:left;max-width:none;width:auto;padding:0;" onclick="showScreen('screen-home')">← Accueil</button>
    </div>

    <div class="spacer-lg"></div>

    <div class="card">
      <h2 class="t-title" style="font-size:2rem;margin-bottom:4px;">Règles</h2>
      <p class="t-label" style="margin-bottom:24px;">Comment jouer à les-affaires-non-resolues</p>

      <div class="rules-section">
        <h3 class="t-heading">L'objectif</h3>
        <p>Un crime a été commis. Vous devez identifier le suspect coupable, l'arme utilisée, et le lieu du crime — en croisant les indices fournis.</p>

        <h3 class="t-heading">La grille de déduction</h3>
        <p>La grille croise chaque suspect avec chaque arme et chaque lieu. Pour chaque case :</p>
        <p>Appuyez une fois pour marquer <span style="color:var(--accent)">◆</span> (confirmé). Appuyez une deuxième fois pour marquer <span style="color:var(--danger)">✕</span> (exclu). Une troisième fois efface la case.</p>
        <p>Une et une seule case par ligne/colonne peut être confirmée.</p>

        <h3 class="t-heading">Les indices</h3>
        <p>Les indices vous donnent des contraintes logiques. Lisez-les attentivement et utilisez la grille pour en déduire la solution.</p>

        <h3 class="t-heading">L'accusation</h3>
        <p>Lorsque vous êtes certain de la solution, rendez-vous dans l'onglet Accusation. Sélectionnez le suspect, l'arme et le lieu, puis portez votre accusation. Vous n'avez qu'une seule chance.</p>

        <h3 class="t-heading">Le temps</h3>
        <p>Un minuteur tourne pendant la partie. Plus vite vous résolvez l'enquête, meilleur est votre score.</p>
      </div>
    </div>

    <div class="mt-12">
      <button class="btn-primary" onclick="showScreen('screen-difficulty'); updateExceptionalCard();">Commencer à enquêter</button>
    </div>
  </section>

  <!-- ══════════════════════════════════════════
       ÉCRAN 2 — DIFFICULTÉ
  ══════════════════════════════════════════ -->
  <section class="screen" id="screen-difficulty">
    <div class="mt-32">
      <button class="btn-tertiary" style="margin:0;text-align:left;max-width:none;width:auto;padding:0;" onclick="showScreen('screen-home')">← Accueil</button>
    </div>

    <div class="spacer-lg"></div>

    <div class="card">
      <h2 class="t-title" style="font-size:2rem;margin-bottom:4px;">Difficulté</h2>
      <p class="t-label" style="margin-bottom:24px;">Choisissez le niveau de l'enquête</p>

      <div class="difficulty-grid" id="difficulty-grid">
        <div class="difficulty-card" data-diff="facile" onclick="selectDifficulty('facile', this)">
          <div>
            <div class="t-heading diff-title">Novice</div>
            <div class="t-label mt-8">3 suspects — 3 armes — 3 lieux</div>
          </div>
          <div class="diff-info">
            <div>10 min</div>
            <div>5 indices</div>
          </div>
        </div>
        <div class="difficulty-card" data-diff="moyen" onclick="selectDifficulty('moyen', this)">
          <div>
            <div class="t-heading diff-title">Inspecteur</div>
            <div class="t-label mt-8">4 suspects — 4 armes — 4 lieux</div>
          </div>
          <div class="diff-info">
            <div>15 min</div>
            <div>7 indices</div>
          </div>
        </div>
        <div class="difficulty-card" data-diff="difficile" onclick="selectDifficulty('difficile', this)">
          <div>
            <div class="t-heading diff-title">Détective</div>
            <div class="t-label mt-8">5 suspects — 5 armes — 5 lieux</div>
          </div>
          <div class="diff-info">
            <div>20 min</div>
            <div>9 indices</div>
          </div>
        </div>

        <div class="difficulty-card exceptional locked" id="exceptional-card" data-diff="exceptionnel">
          <div>
            <div class="exceptional-badge">Dossier d'Exception</div>
            <div class="t-heading diff-title">Le Bal des Masques</div>
            <div class="t-label mt-8">6 suspects — 6 armes — 6 lieux</div>
          </div>
          <div class="diff-info">
            <div>30 min</div>
            <div>10 indices</div>
            <div class="exceptional-status mt-8">3 dossiers restants</div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-12" id="diff-confirm" style="display:none;">
      <button class="btn-primary" onclick="startGame()">Ouvrir le dossier</button>
    </div>
  </section>

  <!-- ══════════════════════════════════════════
       ÉCRAN 3 — INTRO AFFAIRE
  ══════════════════════════════════════════ -->
  <section class="screen" id="screen-intro">
    <div class="mt-32">
      <span class="t-label ambient">Dossier confidentiel</span>
    </div>
    <div class="spacer"></div>

    <div class="card">
      <div class="t-label" id="case-number" style="margin-bottom:12px;">Affaire n° —</div>
      <h2 class="t-title case-title" id="case-title">—</h2>
      <p class="case-body" id="case-desc">—</p>
    </div>

    <div class="card delay-1 mt-12">
      <div class="t-label" style="margin-bottom:12px;">Suspects</div>
      <div class="suspects-list" id="suspects-list"></div>
    </div>

    <div class="card delay-2 mt-12">
      <div class="t-label" style="margin-bottom:12px;">Armes identifiées</div>
      <div class="suspects-list" id="weapons-list"></div>
    </div>

    <div class="card delay-3 mt-12">
      <div class="t-label" style="margin-bottom:12px;">Lieux suspects</div>
      <div class="suspects-list" id="places-list"></div>
    </div>

    <div class="mt-20">
      <button class="btn-primary" onclick="beginInvestigation()">Commencer l'enquête</button>
    </div>
  </section>

  <!-- ══════════════════════════════════════════
       ÉCRAN 4 — JEU PRINCIPAL
  ══════════════════════════════════════════ -->
  <section class="screen" id="screen-game">
    <div class="game-header">
      <div>
        <h2 class="t-title game-title" id="game-title">—</h2>
        <div class="t-label" id="game-difficulty-label">—</div>
      </div>
      <div class="timer" id="game-timer">00:00</div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="grid" onclick="switchTab('grid', this)">Grille</button>
      <button class="tab" data-tab="clues" onclick="switchTab('clues', this)">Indices</button>
      <button class="tab" data-tab="notes" onclick="switchTab('notes', this)">Notes</button>
      <button class="tab" data-tab="accuse" onclick="switchTab('accuse', this)">Accusation</button>
    </div>

    <!-- TAB: Grille -->
    <div class="tab-panel active" id="tab-grid">
      <div id="grid-container"></div>
      <div class="grid-legend">
        <div class="legend-item"><span class="legend-sym" style="color:var(--accent)">◆</span> Confirmé</div>
        <div class="legend-item"><span class="legend-sym" style="color:var(--danger)">✕</span> Exclu</div>
        <div class="legend-item"><span class="legend-sym" style="color:var(--text-muted)">·</span> Inconnu</div>
      </div>
    </div>

    <!-- TAB: Indices -->
    <div class="tab-panel" id="tab-clues">
      <div class="t-label" style="margin-bottom:12px;">Indices disponibles</div>
      <div class="clues-list" id="clues-list"></div>
      <div class="mt-16">
        <div class="t-label" style="margin-bottom:8px; color: var(--text-muted)">Cliquez sur un indice pour le marquer comme utilisé</div>
      </div>
    </div>

    <!-- TAB: Notes -->
    <div class="tab-panel" id="tab-notes">
      <div class="t-label" style="margin-bottom:12px;">Carnet d'enquête</div>
      <textarea class="notes-area" id="notes-area" placeholder="Notez vos déductions, hypothèses et observations ici..."></textarea>
      <div class="mt-12">
        <div class="t-label">Vos notes sont sauvegardées automatiquement</div>
      </div>
    </div>

    <!-- TAB: Accusation -->
    <div class="tab-panel" id="tab-accuse">
      <div class="card" style="margin-bottom:12px;">
        <div class="t-label" style="margin-bottom:8px;">Attention</div>
        <p style="font-size:0.925rem;color:var(--text-secondary);line-height:1.75;">
          Une accusation erronée met fin à l'enquête. N'accusez que lorsque vous êtes certain de votre déduction.
        </p>
      </div>

      <div id="accusation-form">
        <div class="accusation-row">
          <div class="accusation-label">Le coupable est</div>
          <select class="accusation-select" id="acc-suspect">
            <option value="">— Choisir un suspect —</option>
          </select>
        </div>
        <div class="accusation-row">
          <div class="accusation-label">L'arme utilisée est</div>
          <select class="accusation-select" id="acc-weapon">
            <option value="">— Choisir une arme —</option>
          </select>
        </div>
        <div class="accusation-row">
          <div class="accusation-label">Le lieu du crime est</div>
          <select class="accusation-select" id="acc-place">
            <option value="">— Choisir un lieu —</option>
          </select>
        </div>

        <div class="mt-24">
          <button class="btn-danger" onclick="makeAccusation()">Porter l'accusation</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ══════════════════════════════════════════
       ÉCRAN 5 — RÉSULTAT
  ══════════════════════════════════════════ -->
  <section class="screen" id="screen-result">
    <div class="spacer-lg"></div>

    <div class="card text-center">
      <div class="result-icon" id="result-icon">—</div>
      <h2 class="t-title result-title" id="result-title">—</h2>
      <p class="result-sub" id="result-sub">—</p>
    </div>

    <div class="card delay-1 mt-12" id="verdict-card">
      <div class="t-label" style="margin-bottom:12px;">Verdict final</div>
      <div class="verdict-row">
        <span class="verdict-key">Coupable</span>
        <span class="verdict-val" id="v-suspect">—</span>
      </div>
      <div class="verdict-row">
        <span class="verdict-key">Arme</span>
        <span class="verdict-val" id="v-weapon">—</span>
      </div>
      <div class="verdict-row">
        <span class="verdict-key">Lieu</span>
        <span class="verdict-val" id="v-place">—</span>
      </div>
      <div class="verdict-row" id="v-time-row">
        <span class="verdict-key">Temps</span>
        <span class="verdict-val" id="v-time">—</span>
      </div>
    </div>

    <div class="mt-20" style="display:flex;flex-direction:column;gap:12px;">
      <button class="btn-primary" onclick="resetGame()">Nouvelle enquête</button>
      <button class="btn-secondary" onclick="showScreen('screen-home')">Accueil</button>
    </div>
  </section>

</div><!-- /#app -->

<script>
/* ══════════════════════════════════════════════════════════════
   DONNÉES DU JEU
══════════════════════════════════════════════════════════════ */

const CASES = {
  facile: {
    id: "0047",
    title: "Le Dîner de Gala",
    desc: "Un invité a été retrouvé sans vie dans le manoir Valcourt, lors d'un dîner privé réunissant six convives. La porte principale était verrouillée. Le meurtrier se trouve parmi les trois suspects encore présents sur les lieux.",
    suspects: [
      { name: "Édouard Varost", desc: "Antiquaire / 58 ans" },
      { name: "Céleste Moran",  desc: "Botaniste / 34 ans" },
      { name: "Hugo Lefranc",   desc: "Avocat / 45 ans"    },
    ],
    weapons: ["Chandelier", "Poison", "Couteau"],
    places:  ["Bibliothèque", "Cave à vin", "Serre"],
    clues: [
      "Édouard Varost n'a jamais mis les pieds dans la serre — il souffre d'allergies graves.",
      "L'arme du crime ne peut pas être le chandelier : la victime ne présente aucune blessure contondante.",
      "Céleste Moran était en train de noter des observations dans la bibliothèque lors du crime.",
      "La cave à vin était sous surveillance constante — personne n'aurait pu y entrer inaperçu.",
      "Hugo Lefranc a été vu portant des gants de cuisine en fin de soirée, bien qu'il n'ait pas cuisiné.",
    ],
    solution: { suspect: "Hugo Lefranc", weapon: "Poison", place: "Serre" },
    time: 600,
  },
  moyen: {
    id: "0112",
    title: "La Nuit du Vernissage",
    desc: "Le directeur d'une galerie d'art a été découvert mort dans son propre établissement, au lendemain d'un vernissage huppé. Quatre suspects avaient encore accès aux lieux après la fermeture au public.",
    suspects: [
      { name: "Sylvie Arnaud",  desc: "Galeriste / 51 ans"      },
      { name: "Thomas Decourt", desc: "Restaurateur d'art / 39 ans" },
      { name: "Irène Basso",    desc: "Critique d'art / 46 ans"  },
      { name: "Marc Delval",    desc: "Livreur / 28 ans"         },
    ],
    weapons: ["Câble électrique", "Poison", "Statuette", "Scalpel"],
    places:  ["Réserve", "Bureau directorial", "Salle principale", "Toit-terrasse"],
    clues: [
      "Marc Delval a terminé sa livraison avant 19h et n'avait plus accès au bâtiment ensuite.",
      "La statuette exposée était vissée à son socle — impossible à déplacer sans outils spéciaux.",
      "Sylvie Arnaud a passé l'après-vernissage entière dans la salle principale à superviser le rangement.",
      "Des traces de produit chimique corrosif ont été retrouvées dans le bureau directorial.",
      "Thomas Decourt possède une formation en chimie de conservation, lui donnant accès aux produits dangereux.",
      "Le toit-terrasse était inaccessible ce soir-là — l'ascenseur était en panne.",
      "Irène Basso a été aperçue discutant avec la victime dans la réserve peu avant minuit.",
    ],
    solution: { suspect: "Irène Basso", weapon: "Poison", place: "Réserve" },
    time: 900,
  },
  difficile: {
    id: "0213",
    title: "Le Congrès des Ombres",
    desc: "Un éminent professeur a été assassiné lors d'un congrès académique dans un hôtel de montagne isolé. La tempête de neige a empêché toute fuite — le coupable est encore parmi les cinq suspects retenus.",
    suspects: [
      { name: "Professeur Nolin",  desc: "Linguiste / 63 ans"       },
      { name: "Dr. Amara Köse",    desc: "Neurologue / 44 ans"       },
      { name: "Léa Fontanier",     desc: "Doctorante / 29 ans"       },
      { name: "Bernard Clausel",   desc: "Historien / 57 ans"        },
      { name: "Viviane Tort",      desc: "Traductrice / 38 ans"      },
    ],
    weapons: ["Plume empoisonnée", "Câble", "Médicament surdosé", "Arme à feu", "Étouffement"],
    places:  ["Bibliothèque", "Chambre 14", "Salle de conférence", "Sous-sol technique", "Restaurant"],
    clues: [
      "La plume empoisonnée n'a pu être fabriquée que par quelqu'un ayant des connaissances en biochimie.",
      "Dr. Amara Köse dispose de ces connaissances et avait une querelle professionnelle ancienne avec la victime.",
      "Léa Fontanier était présente au restaurant au moment estimé du crime — trois témoins le confirment.",
      "Bernard Clausel souffre de claustrophobie sévère : il évite tout espace sans fenêtre.",
      "Le sous-sol technique n'a pas de fenêtres — aucune ouverture vers l'extérieur.",
      "La chambre 14 était celle de Viviane Tort, dont la carte magnétique est la dernière enregistrée à l'accès.",
      "Le médicament surdosé correspond à une ordonnance prescrite par un médecin — le Dr. Köse en avait les moyens.",
      "La salle de conférence était fermée à clé après 22h — seul le personnel possédait un double.",
      "Professeur Nolin a quitté le restaurant à 21h47 selon les enregistrements de caméra.",
    ],
    solution: { suspect: "Dr. Amara Köse", weapon: "Médicament surdosé", place: "Chambre 14" },
    time: 1200,
  },
  exceptionnel: {
    id: "EX100",
    title: "Le Bal des Masques",
    desc: "Lors d'un bal masqué dans un hôtel historique de la ville, un collectionneur d'art a été retrouvé mort dans la suite présidentielle. La tempête a isolé l'hôtel, et le meurtrier se trouve parmi les six invités restés sur place. L'heure exacte du crime est cruciale pour démêler alibis et mouvements.",
    suspects: [
      { name: "Adèle Vernier",     desc: "Historienne d'art / 42 ans"    },
      { name: "Lucien Morvan",     desc: "Critique gastronomique / 50 ans" },
      { name: "Clémentine Dumas",  desc: "Blogueuse lifestyle / 28 ans"   },
      { name: "Hector Langlois",   desc: "Avocat / 47 ans"                },
      { name: "Sophie Kerjean",    desc: "Directrice de galerie / 39 ans" },
      { name: "Vincent Caron",     desc: "Restaurateur / 55 ans"          },
    ],
    weapons: ["Poison rare", "Couteau de collection", "Chandelier", "Cordage", "Pistolet ancien", "Écharpe de soie"],
    places:  ["Suite présidentielle", "Bibliothèque", "Cuisine", "Salle de bal", "Jardin d'hiver", "Galerie d'art privée"],
    clues: [
      "Le chandelier n'a jamais quitté la salle de bal, mais il présente une empreinte partielle.",
      "Adèle Vernier a été vue dans la bibliothèque à 22h15, mais son carnet est absent — elle ne pouvait pas être partout.",
      "Le poison rare provient d'une collection pharmaceutique que Vincent Caron seul pouvait manipuler.",
      "Clémentine Dumas a filmé le début du bal et apparaît dans la galerie d'art à 21h50 sur sa vidéo.",
      "Hector Langlois a emprunté un cordage dans le jardin d'hiver à 22h05 selon le personnel.",
      "Sophie Kerjean était enfermée dans la suite présidentielle, mais la clé a été remise à un invité à 22h20.",
      "Le pistolet ancien était exposé dans la galerie et a été déplacé — seule une personne en connaissance des lieux pouvait le faire.",
      "L'écharpe de soie appartient à Lucien Morvan, qui prétendait être au buffet entre 22h10 et 22h30.",
      "Des traces de pas dans le jardin d'hiver correspondent à deux suspects différents.",
      "Le meurtre a eu lieu entre 22h15 et 22h25 — déterminer qui était où à ce moment est crucial.",
    ],
    solution: { suspect: "Vincent Caron", weapon: "Poison rare", place: "Suite présidentielle" },
    time: 1800,
  },
};

/* ══════════════════════════════════════════════════════════════
   SUIVI DES CAS JOUÉS
══════════════════════════════════════════════════════════════ */
const REQUIRED_CASES = ['facile', 'moyen', 'difficile'];

function markCasePlayed(diff) {
  const played = JSON.parse(localStorage.getItem('les-affaires-non-resolues_played') || '[]');
  if (!played.includes(diff)) {
    played.push(diff);
    localStorage.setItem('les-affaires-non-resolues_played', JSON.stringify(played));
  }
}

function allRequiredCasesPlayed() {
  const played = JSON.parse(localStorage.getItem('les-affaires-non-resolues_played') || '[]');
  return REQUIRED_CASES.every(d => played.includes(d));
}

function getPlayedCases() {
  return JSON.parse(localStorage.getItem('les-affaires-non-resolues_played') || '[]');
}

/* ══════════════════════════════════════════════════════════════
   ÉTAT DU JEU
══════════════════════════════════════════════════════════════ */
const state = {
  difficulty: null,
  caseData: null,
  gridData: {},
  usedClues: new Set(),
  timerInterval: null,
  elapsed: 0,
  gameActive: false,
};

/* ══════════════════════════════════════════════════════════════
   NAVIGATION
══════════════════════════════════════════════════════════════ */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(id);
  target.classList.add('active');
  target.querySelectorAll('.card').forEach(c => {
    c.style.animation = 'none';
    void c.offsetWidth;
    c.style.animation = '';
  });
}

/* ══════════════════════════════════════════════════════════════
   SÉLECTION DIFFICULTÉ
══════════════════════════════════════════════════════════════ */
function selectDifficulty(diff, el) {
  if (el.classList.contains('locked')) return;
  document.querySelectorAll('.difficulty-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  state.difficulty = diff;
  document.getElementById('diff-confirm').style.display = 'block';
}

/* ══════════════════════════════════════════════════════════════
   DÉMARRER LE JEU
══════════════════════════════════════════════════════════════ */
function startGame() {
  if (!state.difficulty) return;
  const c = CASES[state.difficulty];
  state.caseData = c;
  state.gridData = {};
  state.usedClues = new Set();
  state.elapsed = 0;
  state.gameActive = false;

  document.getElementById('case-number').textContent = `Affaire n° ${c.id}`;
  document.getElementById('case-title').textContent = c.title;
  document.getElementById('case-desc').textContent = c.desc;

  const fillList = (id, items, metaFn) => {
    const el = document.getElementById(id);
    el.innerHTML = '';
    items.forEach((item, i) => {
      const row = document.createElement('div');
      row.className = 'suspect-item';
      const name = typeof item === 'object' ? item.name : item;
      const meta = metaFn ? metaFn(item, i) : '';
      row.innerHTML = `<span class="suspect-name">${name}</span><span class="suspect-meta">${meta}</span>`;
      el.appendChild(row);
    });
  };

  fillList('suspects-list', c.suspects, s => s.desc);
  fillList('weapons-list', c.weapons, (_, i) => `Arme ${String(i+1).padStart(2,'0')}`);
  fillList('places-list', c.places, (_, i) => `Lieu ${String(i+1).padStart(2,'0')}`);

  showScreen('screen-intro');
}

/* ══════════════════════════════════════════════════════════════
   COMMENCER L'ENQUÊTE (depuis l'intro)
══════════════════════════════════════════════════════════════ */
function beginInvestigation() {
  const c = state.caseData;
  document.getElementById('game-title').textContent = c.title;
  const labels = { facile: 'Novice', moyen: 'Inspecteur', difficile: 'Détective', exceptionnel: 'Dossier d\'Exception' };
  document.getElementById('game-difficulty-label').textContent = labels[state.difficulty];

  buildGrid();
  buildClues();
  buildAccusationSelects();

  switchTab('grid', document.querySelector('.tab[data-tab="grid"]'));
  document.getElementById('notes-area').value = '';

  showScreen('screen-game');
  startTimer();
  state.gameActive = true;
}

/* ══════════════════════════════════════════════════════════════
   TIMER
══════════════════════════════════════════════════════════════ */
function startTimer() {
  clearInterval(state.timerInterval);
  state.elapsed = 0;
  const maxTime = state.caseData.time;
  const timerEl = document.getElementById('game-timer');

  state.timerInterval = setInterval(() => {
    state.elapsed++;
    const remaining = maxTime - state.elapsed;

    if (remaining <= 0) {
      clearInterval(state.timerInterval);
      timerEl.textContent = '00:00';
      gameOver(false, 'temps');
      return;
    }

    const m = Math.floor(remaining / 60).toString().padStart(2, '0');
    const s = (remaining % 60).toString().padStart(2, '0');
    timerEl.textContent = `${m}:${s}`;

    timerEl.classList.remove('warning', 'pulsing');
    if (remaining <= 60) {
      timerEl.classList.add('warning', 'pulsing');
    } else if (remaining <= 120) {
      timerEl.classList.add('warning');
    }

    const pct = (remaining / maxTime) * 100;
    document.getElementById('progress-fill').style.width = pct + '%';
  }, 1000);
}

/* ══════════════════════════════════════════════════════════════
   GRILLE DE DÉDUCTION
══════════════════════════════════════════════════════════════ */
function gridKey(a, b) { return `${a}||${b}`; }

function getCellState(a, b) {
  return state.gridData[gridKey(a, b)] || 'empty';
}

function cycleCellState(a, b) {
  const current = getCellState(a, b);
  const next = current === 'empty' ? 'yes' : current === 'yes' ? 'no' : 'empty';
  state.gridData[gridKey(a, b)] = next;
  updateCell(a, b);
  updateProgress();

  if (next === 'yes') {
    autoExclude(a, b);
  }
}

function autoExclude(confirmed_a, confirmed_b) {
  const c = state.caseData;
  const suspects = c.suspects.map(s => s.name);
  const weapons = c.weapons;
  const places = c.places;

  const catA = suspects.includes(confirmed_a) ? 'suspect' : weapons.includes(confirmed_a) ? 'weapon' : 'place';
  const catB = suspects.includes(confirmed_b) ? 'suspect' : weapons.includes(confirmed_b) ? 'weapon' : 'place';

  let listA = catA === 'suspect' ? suspects : catA === 'weapon' ? weapons : places;
  let listB = catB === 'suspect' ? suspects : catB === 'weapon' ? weapons : places;

  listA.forEach(a => {
    if (a !== confirmed_a) {
      const k = gridKey(a, confirmed_b);
      if (state.gridData[k] !== 'yes') {
        state.gridData[k] = 'no';
        updateCell(a, confirmed_b);
      }
    }
  });
  listB.forEach(b => {
    if (b !== confirmed_b) {
      const k = gridKey(confirmed_a, b);
      if (state.gridData[k] !== 'yes') {
        state.gridData[k] = 'no';
        updateCell(confirmed_a, b);
      }
    }
  });
}

function updateCell(a, b) {
  const btn = document.querySelector(`.cell-btn[data-a="${CSS.escape(a)}"][data-b="${CSS.escape(b)}"]`);
  if (!btn) return;
  const st = getCellState(a, b);
  btn.setAttribute('data-state', st);
  btn.textContent = st === 'yes' ? '◆' : st === 'no' ? '✕' : '·';
}

function buildGrid() {
  const c = state.caseData;
  const suspects = c.suspects.map(s => s.name);
  const weapons = c.weapons;
  const places = c.places;
  const container = document.getElementById('grid-container');
  container.innerHTML = '';

  container.appendChild(buildGridTable('Suspects × Armes', suspects, weapons));
  container.appendChild(buildGridTable('Suspects × Lieux', suspects, places));
  container.appendChild(buildGridTable('Armes × Lieux', weapons, places));
}

function buildGridTable(labelText, rows, cols) {
  const wrap = document.createElement('div');
  wrap.style.marginBottom = '24px';

  const label = document.createElement('div');
  label.className = 'grid-section-label';
  label.textContent = labelText;
  wrap.appendChild(label);

  const scrollWrap = document.createElement('div');
  scrollWrap.className = 'grid-wrapper';

  const table = document.createElement('table');
  table.className = 'deduction-grid';

  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  const emptyTh = document.createElement('th');
  emptyTh.textContent = '';
  headRow.appendChild(emptyTh);
  cols.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach(row => {
    const tr = document.createElement('tr');
    const th = document.createElement('td');
    th.textContent = row;
    tr.appendChild(th);
    cols.forEach(col => {
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'cell-btn';
      btn.setAttribute('data-a', row);
      btn.setAttribute('data-b', col);
      btn.setAttribute('data-state', getCellState(row, col));
      btn.textContent = getCellState(row, col) === 'yes' ? '◆' : getCellState(row, col) === 'no' ? '✕' : '·';
      btn.addEventListener('click', () => cycleCellState(row, col));
      td.appendChild(btn);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  scrollWrap.appendChild(table);
  wrap.appendChild(scrollWrap);
  return wrap;
}

/* ══════════════════════════════════════════════════════════════
   PROGRESSION
══════════════════════════════════════════════════════════════ */
function updateProgress() {
  const c = state.caseData;
  const suspects = c.suspects.map(s => s.name);
  const weapons = c.weapons;
  const places = c.places;
  const total = suspects.length * weapons.length + suspects.length * places.length + weapons.length * places.length;
  const filled = Object.values(state.gridData).filter(v => v !== 'empty').length;
  const pct = Math.min(100, Math.round((filled / total) * 100));
}

/* ══════════════════════════════════════════════════════════════
   INDICES
══════════════════════════════════════════════════════════════ */
function buildClues() {
  const c = state.caseData;
  const list = document.getElementById('clues-list');
  list.innerHTML = '';
  c.clues.forEach((clue, i) => {
    const item = document.createElement('div');
    item.className = 'clue-item';
    item.style.animationDelay = (i * 60) + 'ms';
    item.setAttribute('data-index', i);
    item.innerHTML = `
      <div class="clue-number">Indice ${String(i+1).padStart(2,'0')}</div>
      <div class="clue-text">${clue}</div>
    `;
    item.addEventListener('click', () => toggleClue(i, item));
    list.appendChild(item);
  });
}

function toggleClue(i, el) {
  if (state.usedClues.has(i)) {
    state.usedClues.delete(i);
    el.classList.remove('used');
  } else {
    state.usedClues.add(i);
    el.classList.add('used');
  }
}

/* ══════════════════════════════════════════════════════════════
   SELECTS ACCUSATION
══════════════════════════════════════════════════════════════ */
function buildAccusationSelects() {
  const c = state.caseData;
  const suspects = c.suspects.map(s => s.name);

  const fill = (id, items) => {
    const sel = document.getElementById(id);
    sel.innerHTML = `<option value="">— Choisir —</option>`;
    items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      sel.appendChild(opt);
    });
  };

  fill('acc-suspect', suspects);
  fill('acc-weapon', c.weapons);
  fill('acc-place', c.places);
}

/* ══════════════════════════════════════════════════════════════
   TABS
══════════════════════════════════════════════════════════════ */
function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  if (btn) btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

/* ══════════════════════════════════════════════════════════════
   ACCUSATION
══════════════════════════════════════════════════════════════ */
function makeAccusation() {
  const suspect = document.getElementById('acc-suspect').value;
  const weapon  = document.getElementById('acc-weapon').value;
  const place   = document.getElementById('acc-place').value;

  if (!suspect || !weapon || !place) {
    [!suspect && 'acc-suspect', !weapon && 'acc-weapon', !place && 'acc-place'].forEach(id => {
      if (!id) return;
      const el = document.getElementById(id);
      el.style.borderColor = 'var(--danger)';
      setTimeout(() => { el.style.borderColor = ''; }, 1200);
    });
    return;
  }

  const sol = state.caseData.solution;
  const correct = suspect === sol.suspect && weapon === sol.weapon && place === sol.place;

  clearInterval(state.timerInterval);
  state.gameActive = false;

  gameOver(correct, 'accusation', { suspect, weapon, place });
}

/* ══════════════════════════════════════════════════════════════
   GAME OVER
══════════════════════════════════════════════════════════════ */
function gameOver(victory, reason, accusation = null) {
  const sol = state.caseData.solution;
  const timeUsed = state.elapsed;
  const totalTime = state.caseData.time;

  if (victory) {
    const bestKey = `les-affaires-non-resolues_best_${state.difficulty}`;
    const prev = parseInt(localStorage.getItem(bestKey) || '99999');
    if (timeUsed < prev) {
      localStorage.setItem(bestKey, timeUsed);
    }
    updateBestTime();
  }

  if (state.difficulty !== 'exceptionnel') {
    markCasePlayed(state.difficulty);
  }
  updateExceptionalCard();

  const iconEl   = document.getElementById('result-icon');
  const titleEl  = document.getElementById('result-title');
  const subEl    = document.getElementById('result-sub');

  if (victory) {
    iconEl.textContent = 'Résolu';
    iconEl.className = 'result-icon victory';
    titleEl.textContent = 'Affaire classée';
    titleEl.className = 't-title result-title';
    const m = Math.floor(timeUsed / 60).toString().padStart(2,'0');
    const s = (timeUsed % 60).toString().padStart(2,'0');
    subEl.textContent = `Vous avez résolu l'enquête en ${m}:${s}. Votre déduction était correcte.`;
  } else if (reason === 'temps') {
    iconEl.textContent = 'Échec';
    iconEl.className = 'result-icon defeat';
    titleEl.textContent = 'Le temps s\'est écoulé';
    titleEl.className = 't-title result-title';
    subEl.textContent = `Vous n'avez pas résolu l'enquête à temps. Le dossier reste ouvert.`;
  } else {
    iconEl.textContent = 'Faux';
    iconEl.className = 'result-icon defeat';
    titleEl.textContent = 'Accusation erronée';
    titleEl.className = 't-title result-title';
    subEl.textContent = `Votre accusation était incorrecte. L'enquête est compromise.`;
  }

  const vSuspect = document.getElementById('v-suspect');
  const vWeapon  = document.getElementById('v-weapon');
  const vPlace   = document.getElementById('v-place');
  const vTime    = document.getElementById('v-time');

  vSuspect.textContent = sol.suspect;
  vWeapon.textContent  = sol.weapon;
  vPlace.textContent   = sol.place;

  if (accusation) {
    vSuspect.className = 'verdict-val ' + (accusation.suspect === sol.suspect ? 'correct' : 'wrong');
    vWeapon.className  = 'verdict-val ' + (accusation.weapon === sol.weapon   ? 'correct' : 'wrong');
    vPlace.className   = 'verdict-val ' + (accusation.place === sol.place     ? 'correct' : 'wrong');
  } else {
    vSuspect.className = vWeapon.className = vPlace.className = 'verdict-val';
  }

  if (victory) {
    const m = Math.floor(timeUsed / 60).toString().padStart(2,'0');
    const s = (timeUsed % 60).toString().padStart(2,'0');
    vTime.textContent = `${m}:${s}`;
    document.getElementById('v-time-row').style.display = 'flex';
  } else {
    document.getElementById('v-time-row').style.display = 'none';
  }

  showScreen('screen-result');
}

/* ══════════════════════════════════════════════════════════════
   RESET
══════════════════════════════════════════════════════════════ */
function resetGame() {
  clearInterval(state.timerInterval);
  state.difficulty = null;
  state.caseData = null;
  state.gridData = {};
  state.usedClues = new Set();
  state.gameActive = false;

  document.querySelectorAll('.difficulty-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('diff-confirm').style.display = 'none';
  updateExceptionalCard();

  showScreen('screen-difficulty');
}

/* ══════════════════════════════════════════════════════════════
   MEILLEUR TEMPS
══════════════════════════════════════════════════════════════ */
function updateBestTime() {
  const diffs = ['facile', 'moyen', 'difficile', 'exceptionnel'];
  let best = null;
  diffs.forEach(d => {
    const t = parseInt(localStorage.getItem(`les-affaires-non-resolues_best_${d}`) || '0');
    if (t > 0 && (best === null || t < best)) best = t;
  });
  const el = document.getElementById('best-time');
  if (best !== null) {
    const m = Math.floor(best / 60).toString().padStart(2,'0');
    const s = (best % 60).toString().padStart(2,'0');
    el.textContent = `${m}:${s}`;
    el.style.color = 'var(--accent)';
  }
}

/* ══════════════════════════════════════════════════════════════
   CARTE EXCEPTIONNELLE — DÉVERROUILLAGE
══════════════════════════════════════════════════════════════ */
function updateExceptionalCard() {
  const card = document.getElementById('exceptional-card');
  if (!card) return;
  const unlocked = allRequiredCasesPlayed();
  const played = getPlayedCases();

  if (unlocked) {
    card.classList.remove('locked');
    card.onclick = () => selectDifficulty('exceptionnel', card);
    card.querySelector('.exceptional-status').textContent = 'Déverrouillé';
    card.querySelector('.exceptional-status').style.color = 'var(--accent)';
  } else {
    card.classList.add('locked');
    card.onclick = null;
    const remaining = REQUIRED_CASES.filter(d => !played.includes(d)).length;
    card.querySelector('.exceptional-status').textContent =
      `${remaining} dossier${remaining > 1 ? 's' : ''} restant${remaining > 1 ? 's' : ''}`;
  }
}

/* ══════════════════════════════════════════════════════════════
   INIT
══════════════════════════════════════════════════════════════ */
updateBestTime();
updateExceptionalCard();
</script>
</body>
</html>
